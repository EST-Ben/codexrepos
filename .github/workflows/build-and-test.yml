name: Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  lint-python:
    name: Lint Python Tools
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy

      - name: Run flake8
        run: |
          flake8 Tools/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 Tools/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics
        continue-on-error: true

      - name: Check formatting with black
        run: black --check Tools/
        continue-on-error: true

      - name: Check imports with isort
        run: isort --check-only Tools/
        continue-on-error: true

  test-validators:
    name: Test Validators
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov jsonschema

      - name: Run validator tests
        run: |
          python -m pytest Tools/validators/ -v --tb=short || true

      - name: Test validator execution
        run: |
          python Tools/validators/validate_game_data.py --root . --json > validation-results.json
          cat validation-results.json

  test-generators:
    name: Test Generators
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

      - name: Test dungeon generator
        run: |
          python Tools/generators/dungeon_generator.py --output test_dungeon.json --seed 12345
          echo "Generated dungeon:"
          head -50 test_dungeon.json

      - name: Test loot table generator
        run: |
          python Tools/generators/loot_table_generator.py --output test_loot.json --preview
          echo "Generated loot table:"
          head -50 test_loot.json

      - name: Upload generated files
        uses: actions/upload-artifact@v4
        with:
          name: generated-test-files
          path: |
            test_dungeon.json
            test_loot.json

  validate-openapi:
    name: Validate OpenAPI Spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install OpenAPI validator
        run: npm install -g @apidevtools/swagger-cli

      - name: Validate OpenAPI specification
        run: |
          swagger-cli validate Server/api/openapi.yaml

      - name: Generate API documentation preview
        run: |
          npm install -g redocly-cli
          redocly lint Server/api/openapi.yaml || true

  validate-sql:
    name: Validate SQL Migrations
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run migrations
        run: |
          for migration in Server/migrations/*.sql; do
            echo "Running: $migration"
            PGPASSWORD=test psql -h localhost -U test -d test_db -f "$migration"
          done
        env:
          PGPASSWORD: test

      - name: Verify schema
        run: |
          PGPASSWORD=test psql -h localhost -U test -d test_db -c "\dt" > tables.txt
          cat tables.txt
          PGPASSWORD=test psql -h localhost -U test -d test_db -c "\df" > functions.txt
          cat functions.txt

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install bandit safety

      - name: Run Bandit security scan
        run: |
          bandit -r Tools/ -f json -o bandit-report.json || true
          cat bandit-report.json

      - name: Check for secrets
        run: |
          # Simple check for potential secrets in JSON files
          echo "Checking for potential secrets..."
          grep -r -i "password\|secret\|api_key\|token" --include="*.json" Data/ UE5/ Server/ || echo "No obvious secrets found"

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint-python, test-validators, test-generators, validate-openapi, validate-sql, security-scan]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Python | ${{ needs.lint-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Validators | ${{ needs.test-validators.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Generators | ${{ needs.test-generators.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate OpenAPI | ${{ needs.validate-openapi.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate SQL | ${{ needs.validate-sql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
